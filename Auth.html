<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Authenticating with Frankly</title>
    <meta name="keywords" content="Frankly Platform" />
    <link type="text/css" rel="stylesheet" href="css/main.css">
    <link type="text/css" rel="stylesheet" href="css/bootstrap.css">	
    <link rel="stylesheet" type="text/css">
	<script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js?skin=sunburst"></script>	
	
</head>

<div class="sidebar-container" data-role="main">

<div class="sidebar-logo"></div>

	<div class="sidebar-content">
		<ul class="sidebar" id="sidenavbar">
			<li><a href="index.html">Getting Started</a>
			<li><a href="InstallSDK.html">Installing the SDK</a>
			<li><a href="InitializeSDK.html">Initializing the SDK</a>
			<li>Authenticating with Frankly
				<ul>
					<li><a href="#summary">Summary</a>
					<li><a href="#jwt">JWT</a>
					<li><a href="#auth_flow">Server Authentication</a>
					<li><a href="#client_auth">Client Authentication</a>
					<li><a href="security">A Note on Security</a>
				</ul>
			<li><a href="BasicIntegration.html">Basic Integration</a>
			<li><a href="AdvancedIntegrations.html">Advanced Integrations</a>
			<li><a href="APIReference.html">API Reference</a>
			<li><a href="downloads.html">Downloads</a>				
			<li><a href="Support.html">Support</a>
		</ul>
	</div>

</div>


<div class="header">
	<h1 class="noborder">
		Authenticating with Frankly
	</h1>

<br>

		<ul>	
			<li><a href="#summary">Summary</a>
			<li><a href="#jwt">JWT</a>
			<li><a href="#auth_flow">Server Authentication Flow</a>
			<li><a href="#client_auth">Handling Authentication in the Client</a>
				<ul>
					<li><a href="#ios_auth">iOS SDK</a>
					<li><a href="#android_auth">Android SDK</a>
					<li><a href="#js_auth">JavaScript SDK</a>
				</ul>
			<li><a href="security">A Note on Security</a>
		</ul>
	
</div>

<br>
<br>

<div class="doc">

		<a id="summary">
			<h3>
				Summary
			</h3>
		</a>
	
		<p>
			This document describes how the Frankly Authentication works and what components Frankly partners must build in order to support authentication of their users on Frankly’s infrastructure.
		</p>


<br>
<br>


		<a id="jwt">
			<h3>
				JWT
			</h3>
		</a>

		<p>
			Frankly Authentication mechanism is based on JWT (JSON Web Token), a web standard for sharing user authentication in a secure way. JWT libraries are provided for all popular programming languages and are referenced at <a href="http://jwt.io/">jwt.io</a>. The full JWT specifications can be found <a href="https://openid.net/specs/draft-jones-json-web-token-07.html">here</a>, the reader should consult and become familiar with how JWT works prior to continuing with this document.
		</p>


<br>
<br>


		<a id="auth_flow">
			<h3>
				Server Authentication Flow
			</h3>
		</a>

				<h4>
					1. Generate a Nonce Value
	
				</h4>

		<p>
			JSON Web Tokens embed a unique value called nonce which is used to protect against man-in-the-middle attacks by adding a random component to the token in order to make it impossible to predict a valid token.
		</p>

		<p>
			Frankly’s infrastructure provides a public HTTP endpoint that must be queried to generate a nonce value as a first step of the authentication flow. The response contains the nonce value represented as a JSON string which can be used for only one authentication attempt.
		</p>

		<p>
			Example: GET request to https://app.franklychat.com/auth/nonce to get a nonce value.
		</p>

<div  style="width:80%;">
<pre class="prettyprint"><code>
	$ curl -X GET https://app.franklychat.com/auth/nonce
	"054afc088ea94717aa6121768f13a57a"
</code></pre>
</div>


<br>
<br>


		<h4>
			2. Generate an Identity Token
		</h4>

		<p>
			After getting a nonce value from Frankly’s infrastructure, the partner app has to generate an identity token that embeds user’s information and is signed using the secret key that can be found in the <a href="https://console.franklychat.com/">Frankly Console</a>.
		</p>

		<p>
			The JWT token must have the following structure:
		</p>

<div style="width:80%">
<pre class="prettyprint"><code>
	Header

	{
	  “typ”: “JWS”,
	  “alg”: “HS256”,
	  “cty”: “frankly-it;v1”
	}

	Claims

	{
	  “aak”: <authentication key obtained from frankly console>,
	  “uid”: <unique user identifier> (optional),
	  “iat”: <token generation time as a unix timestamp>,
	  “exp”: <token expiration time as a unix timestamp>,
	  “nce”: <nonce value obtained in step 1>,
	  “role”: ”admin” (optional)
	}

	Signature

	HMACSHA256(
	base64UrlEncode(Header) + "." +	base64UrlEncode(Claims),
	&lt;authentication secret obtained from frankly console&gt;
	)
</code></pre>
</div>

<br>

		<p>
			Once encoded and signed with the authentication secret the app should have a value that looks like this:
		</p>

<br>

<div  style="width:80%;">
<pre class="prettyprint"><code>
Identity Token

eyJ0eXAiOiJKV1MiLCJhbGciOiJIUzI1NiIsImN0eSI6ImZyYW5rbHktaXQ7djEifQ.eyJhYWsiOiIwMTIzNDU2Nzg5IiwidWlkIjoxMjM0NTY3ODkwLCJpYXQiOjEyMzQ1Njc4OTAsImV4cCI6MTIzNDU2Nzg5MCwibmNlIjoiMDU0YWZjMDg4ZWE5NDcxN2FhNjEyMTc2OGYxM2E1N2EifQ.BawHATknj5vTB5GF8yz0b-pAVidGF9enV0WBU6dirPo
</code></pre>
</div>

<br>
<br>

		<h4>
			3. Generate a Session Token
		</h4>

		<p>
			After generating an identity token the app can then request a session token to be able to use Frankly’s API. Obtaining a session token can be done by querying https://app.franklychat.com/auth and setting the identity_token query string parameter to the value generated in step 2. This session token will come in the response as two cookies (token and xsrf) that the HTTP client should set whenever it attempts to use any of the Frankly API endpoints. Example: GET request on <a href="https://app.franklychat.com/auth">https://app.franklychat.com/auth</a>
		</p>

<div  style="width:80%;">
<pre class="prettyprint"><code>
	$ curl -v -X GET https://app.franklychat.com/auth?identity_token=...
	> GET /auth?identity_token=... HTTP/1.1
	> Host: app.franklychat.com
	> ...
	> 
	< HTTP/1.1 200 OK
	< Set-Cookie: token=<session token>
	< Set-Cookie: xsrf=<xsrf token>
	< ...
	<
</code></pre>
</div>

<br>
<br>

	<a id="client_auth">
		<h3>
			Handling Authentication in the Client
		</h3>
	</a>
	
	<p>
		Now that your server knows how to communicate with Frankly servers as an authenticated application, let's make sure you're client is able to get the right information to interact with the Frankly SDK. 
	</p>

<br>
<br>
	
	<a id="ios_auth">
		<h4>
			Authenticating the iOS SDK
		</h4>
	</a>
	
		<p>
			Set the FranklySDK’s <code>authenticationDelegate</code> to an object that conforms to the <code>FranklySDKAuthenticationDelegate</code> protocol.
		</p>
		
		<p>
			In our example code, we’ve made our <code>ViewController</code> conform to the protocol:
		</p>

<br>

<div  style="width:80%;">
<pre class="prettyprint"><code class="lang-cpp">
	@interface ViewController : UIViewController &lt;FranklySDKAuthenticationDelegate&gt;
</code></pre>
</div>

<br>

		<p>
			You set the FranklySDK authenticationDelegate and initiate authentication as follows:
		</p>

<br>

<div  style="width:80%;">
<pre class="prettyprint"><code class="lang-cpp">
- (void)viewDidLoad {

	[super viewDidLoad];

	[FranklySDK sharedInstance].authenticationDelegate = self;

	[[FranklySDK sharedInstance] initiateAuthentication];

}
</code></pre>
</div>

<br>

		<p>
			Next you will need to set up the following:
	
			
			<ul>
				<li><code>FranklyAuthenticationDelegate</code> requires the following functions:
					<ul>
						<li><code>identifierWithNonce:completion:</code><br>

		This method is where you should utilize your back end server as detailed in Frankly Server Authentication document to create a valid identifier. The user ID sent to the server is optional, however, if you choose not to include a user ID then the user will only be allowed in Spectator Mode.  If a user in Spectator Mode attempts to participate it will trigger a call to the delegate’s doUserAuthentication method at which point you should present a login screen. When your server responds with the identifier, call completion to finish the authentication process.

						<li><strong>You must call completion or the process will never finish.</strong>
						<li>We have included a test function in <code>FranklySDK.h, retrieveIdentitifierWithUserID:Nonce:authKey:authSecret:completionBlock,</code> that will allow you to bypass your server and retrieve an identifier from Frankly’s servers.  Because it requires putting in your auth key and secret, <strong>it is only for testing.</strong>

						<ul>
							<li>Your Auth Key and Auth Secret can be found within the <a href="https://console.franklychat.com/">Admin Console</a> under Settings
						</ul>
					</ul>
					<li><code>authenticationDidSucceedWithUserID:(NSNumber*)</code> - After this message is received, you may use the SDK.
					<li><code>authenticationDidFailWithError:(NSError*)</code> - If this message is received, you need to start authentication process over before you may use the SDK. 
			</ul>

		</p>

<br>

<div  style="width:80%;">
<pre class="prettyprint"><code class="lang-cpp">
- (void)identifierWithNonce:(NSString *)nonce completion:(void (^)(NSString *identifier))completion {

    FranklySDK *franklySDK = [FranklySDK sharedInstance];

    // ONLY FOR TESTING - REQUEST IDENTIFIER FROM YOUR SERVER 
    [franklySDK retrieveIdentitifierWithUserID:self.userId
                                         Nonce:nonce
                                       authKey:self.authKey
                                    authSecret:self.authSecret
                               completionBlock:^(NSString *identifier, NSError *error) {
        if (identifier != nil) {
            completion(identifier);
        }
    }];
}
</code></pre>
</div>

<br>

<div  style="width:80%;">
<pre class="prettyprint"><code class="lang-cpp">
- (void)authenticationDidSucceedWithUserID:(NSNumber *)userID {

	NSLog(@"authentication did succeed");

}
</code></pre>
</div>

<br>

<div  style="width:80%;">
<pre class="prettyprint"><code class="lang-cpp">
- (void)authenticationDidFailWithError:(NSError *)error {

	NSLog(@"authentication did fail");
}
</code></pre>
</div>

<br>

			<p>
				Once you're done setting up those pieces, try running the build.
			</p>

<br>
<br>

		<a id="android_auth">
			<h4>
				Authenticating the Android SDK
			</h4>
		</a>
	
		<p>	
			Partners must implement an <code>OnAuthenticationRequestListener</code> class to handle user authentication:
		</p>

<div  style="width:80%;">		
<pre class="prettyprint"><code class="lang-java">
private class MyOnAuthenticationRequestListener implements Authenticator.OnAuthenticationRequestListener {
    public void onAuthenticationRequest(final Authenticator authenticator, final String nonce) {
        // For security, post nonce to your backend to retrieve an identity token
        final String identityToken = "&lt;my_identity_token&gt;";

        try {
            authenticator.authenticate(identityToken);
        } catch (final IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
</div>

		<p>
			<strong>Note:</strong> The identity token is meant to be retrieved from the Partner’s servers rather than being hardcoded into the app.
		</p>

		<p>
			After defining the <code>OnAuthenticationRequestListener</code> class, Partners must create an instance of the class and pass it into the Frankly Android SDK’s Authenticator class:
		</p>

<div  style="width:80%;">		
<pre class="prettyprint"><code class="lang-java">
Authenticator authenticator = Authenticator.getInstance(context);
authenticator.setOnAuthenticationRequestListener(authenticationRequestListener);
</code></pre>
</div>
	
<br>
<br>

		<a id="js_auth">
			<h4>
				Authenticating the JavaScript SDK
			</h4>
		</a>
		
		<p>
			Here's how to perform authentication from a Node.js:
		</p>

<div  style="width:80%;">		
<pre class="prettyprint"><code class="lang-js">
	var FranklyClient = require ( 'frankly-js' ) .FranklyClient
	
	var appKey = 'appKey from Frankly Console'
	var appSecret = 'appSecret from Frankly Console'
	
	var client = new FranklyClient()
	client.open (appKey, appSecret)
</code></pre>
</div>

		<p>
			When authenticating from a client application running in the browser the <code>appKey</code> and <code>appSecret</code> values shouldn't be exposed and the application's backend servers must generate the identity token using the secret and return it to the client to successfully authenticate.
		</p>
		
		<p>
			Here's how to perform authentication form a browser application:
		</p>
		
<div  style="width:80%;">		
<pre class="prettyprint"><code class="lang-js">
var client = new frankly.FranklyClient

    client.open(function (nonce) {
        return new Promise(function (resolve, reject) {
            var req = new XMLHttpRequest()

            req.onreadystatechange = function () {
                if (req.readyState === 4) {
                    if (req.status === 200) {
                         resolve(req.responseText)
                    } else {
                         reject('something went wrong')
                    }
                }
            }

            req.open('https://partner.domain.com/identity-token?nonce=' + nonce)
            req.send()
        })
    })
</code></pre>
</div>

		<p>
			The client instance automatically performs reconnection and reauthentication when necessary so the method passed to <a href="http://franklyinc.github.io/frankly-js/FranklyClient.html#open" target="_blank">FranklyClient#open</a> may be called multiple times.
		</p>
	
<br>
<br>
	
	<a id="Security">
		<h3>
			A Note on Security
		</h3>
	</a>
	
	<p>
		In all cases, your application's <code>appKey</code> and <code>appSecret</code> should NOT be stored on the client and your application's backend servers should be responsible for generating identity tokens, using the <code>appSecret</code> to return it to the client to successfully authenticate. Storing your application's <code>appKey</code> and <code>appSecret</code> exposes you to unnecessary security risks where an attacker could obtain these values to communicate with Frankly services on your behalf. Please note that some examples do highlight the ability to directly authenticate with Frankly services from your application's client, however these are also noted as examples meant for checking progress of early integration steps.
	</p>
	
</div>

<br>
<br>
<br>
<br>

<!--
<div class="well-bottom-nav">
	<div class="panel panel-default">
		<div class="panel-body">
			<h4 align="right">
				<a href="BasicIntegration.html">Next: Basic Integration <span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span></a>
			</h4>
		</div>
	</div>
</div>
-->

<div class="pager-container">
<nav>
  <ul class="pager">
    <li class="previous"><a href="InitializeSDK.html"><span aria-hidden="true">&larr;</span> Initializing the SDK</a></li>
    <li class="next"><a href="BasicIntegration.html">Basic Integration <span aria-hidden="true">&rarr;</span></a></li>
  </ul>
</nav>
</div>

<br>
<br>


</div>

</html>